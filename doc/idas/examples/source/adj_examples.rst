..
   -----------------------------------------------------------------------------
   SUNDIALS Copyright Start
   Copyright (c) 2025-2026, Lawrence Livermore National Security,
   University of Maryland Baltimore County, and the SUNDIALS contributors.
   Copyright (c) 2013-2025, Lawrence Livermore National Security
   and Southern Methodist University.
   Copyright (c) 2002-2013, Lawrence Livermore National Security.
   All rights reserved.

   See the top-level LICENSE and NOTICE files for details.

   SPDX-License-Identifier: BSD-3-Clause
   SUNDIALS Copyright End
   -----------------------------------------------------------------------------

.. _IDAS.Examples.ASA:

Adjoint Sensitivity Analysis Examples
======================================

The next two subsections describe a serial example (``idasAkzoNob_ASAi_dns``)
and a parallel one (``idasBruss_ASAp_kry_bbd_p``). For details on the other
examples, the reader is directed to the comments in their source files.

A serial dense example: idasAkzoNob_ASAi_dns
---------------------------------------------

The ``idasAkzoNob_ASAi_dns`` program solves the Akzo-Nobel chemical kinetics
problem, which consists of six nonlinear DAEs. The system has index 1. The
problem originates from Akzo Nobel Central research in Arnhem, The Netherlands,
and describes a chemical process in which two species are mixed, while carbon
dioxide is continuously added.

The problem is of the form

.. math::
   :label: DAEan

   \begin{split}
   y' &= f(y, z) \\
   0  &= g(y, z)
   \end{split}

with :math:`y \in \mathbb{R}^5` and :math:`z \in \mathbb{R}`. The function
:math:`f` is defined by

.. math::

   f(y, z) = \begin{bmatrix}
   -2r_1 + r_2 - r_3 - r_4 \\
   -\frac{1}{2}r_1 - r_4 - \frac{1}{2}r_5 + F_{\mathrm{in}} \\
   r_1 - r_2 + r_3 \\
   -r_2 + r_3 - 2r_4 \\
   r_2 - r_3 + r_5
   \end{bmatrix}

where the :math:`r_i` and :math:`F_{\mathrm{in}}` are auxiliary variables,
given by

.. math::

   \begin{split}
   r_1 &= k_1 y_1^4 y_2^{1/2} \\
   r_2 &= k_2 y_3 y_4 \\
   r_3 &= \frac{k_2}{K} y_1 y_5 \\
   r_4 &= k_3 y_1 y_4^{1/2} \\
   r_5 &= k_4 z^2 y_2^{1/2} \\
   F_{\mathrm{in}} &= klA \left( \frac{p(CO_2)}{H} - y_2 \right) \,.
   \end{split}

The function :math:`g` in the algebraic equation is defined by

.. math::

   g(y, z) = K_s y_1 y_4 - z \,.

It is clear from the fact that the Jacobian :math:`\partial g / \partial z` is
non-singular that the DAE :eq:`DAEan` has (differentiation) index 1. See
http://pitagora.dm.uniba.it/~testset/report/chemakzo.pdf for details.

The problem is solved with the :ref:`dense linear solver <SUNLinSol_Dense>`
using the default difference quotient dense Jacobian approximation. The adjoint
capability of IDAS is used to compute gradients with respect to the initial
values of :math:`y` of the integral

.. math::

   G = \int_0^{t_f} y_1 \, dt \,,

where :math:`y_1` is the concentration of the first species. The initial value
of :math:`z` cannot be taken as a free parameter, since its value is determined
by the value of :math:`y`. The sensitivity of :math:`G` with respect to the
initial values of :math:`y` is given by the first five components of the
solution of the adjoint system, evaluated at :math:`t = 0`.

The output generated by ``idasAkzoNob_ASAi_dns`` is shown below.

.. literalinclude:: ../../../../examples/idas/serial/idasAkzoNob_ASAi_dns.out
   :language: none

A parallel example using IDABBDPRE: idasBruss_ASAp_kry_bbd_p
-------------------------------------------------------------

The ``idasBruss_ASAp_kry_bbd_p`` program solves the same problem as
``idasBruss_kry_bbd_p`` and ``idasBruss_FSA_kry_bbd_p``, namely the Brusselator
PDE system (see the previous section on forward sensitivity examples). In
addition, it uses an adjoint sensitivity approach to compute the gradients of
the model output functional

.. math::

   g(t) = \int \int u(t,x,y)\,dx\,dy \,.

For perturbations :math:`\delta u_0` and :math:`\delta v_0` in the initial
profiles :math:`u` and :math:`v`, the perturbation of :math:`g` at the final
time is

.. math::

   \delta g(t_f) = \int \int [\lambda(0,x,y) \delta u_0 + \mu(0,x,y) \delta v_0] \,dx\,dy \,,

where :math:`\lambda(t,x,y)` and :math:`\mu(t,x,y)` are the solutions of the
adjoint PDEs,

.. math::

   \begin{split}
   \frac{\partial \lambda}{\partial t} &= -\epsilon_1 (\lambda_{xx} + \lambda_{yy})
                               - (2 u v - B - 1) \lambda + (2 u v - B) \mu \\
   \frac{\partial \mu}{\partial t} &= -\epsilon_2 (\mu_{xx} + \mu_{yy})
                               - u^2 \lambda + u^2 \mu \,,
   \end{split}

with Neumann boundary conditions, and initial (final time) conditions

.. math::

   \lambda (t_f,x,y) = 1 \,, \quad \mu (t_f,x,y) = 0 \,.

The adjoint PDEs are discretized and solved in the same way as the Brusselator
PDEs.

A sample output generated by ``idasBruss_ASAp_kry_bbd_p`` is shown below.

.. literalinclude:: ../../../../examples/idas/parallel/idasBruss_ASAp_kry_bbd_p.out
   :language: none
